<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>stores/utils.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/paychex/core" target="_blank" class="menu-item" id="repository" >Source Code</a></h2><h3>Classes</h3><ul><li><a href="Action.html">Action</a><ul class='methods'><li data-type='method'><a href="Action.html#execute">execute</a></li><li data-type='method'><a href="Action.html#failure">failure</a></li><li data-type='method'><a href="Action.html#init">init</a></li><li data-type='method'><a href="Action.html#retry">retry</a></li><li data-type='method'><a href="Action.html#rollback">rollback</a></li><li data-type='method'><a href="Action.html#success">success</a></li></ul></li><li><a href="ActiveModelList.html">ActiveModelList</a><ul class='methods'><li data-type='method'><a href="ActiveModelList.html#active">active</a></li><li data-type='method'><a href="ActiveModelList.html#add">add</a></li><li data-type='method'><a href="ActiveModelList.html#clear">clear</a></li><li data-type='method'><a href="ActiveModelList.html#fire">fire</a></li><li data-type='method'><a href="ActiveModelList.html#items">items</a></li><li data-type='method'><a href="ActiveModelList.html#next">next</a></li><li data-type='method'><a href="ActiveModelList.html#on">on</a></li><li data-type='method'><a href="ActiveModelList.html#one">one</a></li><li data-type='method'><a href="ActiveModelList.html#prev">prev</a></li><li data-type='method'><a href="ActiveModelList.html#remove">remove</a></li><li data-type='method'><a href="ActiveModelList.html#resume">resume</a></li><li data-type='method'><a href="ActiveModelList.html#stop">stop</a></li></ul></li><li><a href="AutoResetSignal.html">AutoResetSignal</a><ul class='methods'><li data-type='method'><a href="AutoResetSignal.html#ready">ready</a></li><li data-type='method'><a href="AutoResetSignal.html#reset">reset</a></li><li data-type='method'><a href="AutoResetSignal.html#set">set</a></li></ul></li><li><a href="Cache.html">Cache</a><ul class='methods'><li data-type='method'><a href="Cache.html#get">get</a></li><li data-type='method'><a href="Cache.html#set">set</a></li></ul></li><li><a href="CountdownSignal.html">CountdownSignal</a><ul class='methods'><li data-type='method'><a href="CountdownSignal.html#decrement">decrement</a></li><li data-type='method'><a href="CountdownSignal.html#increment">increment</a></li><li data-type='method'><a href="CountdownSignal.html#ready">ready</a></li></ul></li><li><a href="DataDefinition.html">DataDefinition</a></li><li><a href="DataLayer.html">DataLayer</a><ul class='methods'><li data-type='method'><a href="DataLayer.html#createRequest">createRequest</a></li><li data-type='method'><a href="DataLayer.html#fetch">fetch</a></li><li data-type='method'><a href="DataLayer.html#setAdapter">setAdapter</a></li></ul></li><li><a href="EncryptionConfiguration.html">EncryptionConfiguration</a></li><li><a href="EventBus.html">EventBus</a><ul class='methods'><li data-type='method'><a href="EventBus.html#fire">fire</a></li><li data-type='method'><a href="EventBus.html#on">on</a></li><li data-type='method'><a href="EventBus.html#one">one</a></li><li data-type='method'><a href="EventBus.html#resume">resume</a></li><li data-type='method'><a href="EventBus.html#stop">stop</a></li></ul></li><li><a href="ExecutionPromise.html">ExecutionPromise</a></li><li><a href="FilteredModelList.html">FilteredModelList</a><ul class='methods'><li data-type='method'><a href="FilteredModelList.html#add">add</a></li><li data-type='method'><a href="FilteredModelList.html#clear">clear</a></li><li data-type='method'><a href="FilteredModelList.html#filterBy">filterBy</a></li><li data-type='method'><a href="FilteredModelList.html#fire">fire</a></li><li data-type='method'><a href="FilteredModelList.html#items">items</a></li><li data-type='method'><a href="FilteredModelList.html#on">on</a></li><li data-type='method'><a href="FilteredModelList.html#one">one</a></li><li data-type='method'><a href="FilteredModelList.html#remove">remove</a></li><li data-type='method'><a href="FilteredModelList.html#resume">resume</a></li><li data-type='method'><a href="FilteredModelList.html#stop">stop</a></li></ul></li><li><a href="GroupedModelList.html">GroupedModelList</a><ul class='methods'><li data-type='method'><a href="GroupedModelList.html#add">add</a></li><li data-type='method'><a href="GroupedModelList.html#clear">clear</a></li><li data-type='method'><a href="GroupedModelList.html#fire">fire</a></li><li data-type='method'><a href="GroupedModelList.html#groupBy">groupBy</a></li><li data-type='method'><a href="GroupedModelList.html#groups">groups</a></li><li data-type='method'><a href="GroupedModelList.html#items">items</a></li><li data-type='method'><a href="GroupedModelList.html#on">on</a></li><li data-type='method'><a href="GroupedModelList.html#one">one</a></li><li data-type='method'><a href="GroupedModelList.html#remove">remove</a></li><li data-type='method'><a href="GroupedModelList.html#resume">resume</a></li><li data-type='method'><a href="GroupedModelList.html#stop">stop</a></li></ul></li><li><a href="InvocationData.html">InvocationData</a></li><li><a href="ManualResetSignal.html">ManualResetSignal</a><ul class='methods'><li data-type='method'><a href="ManualResetSignal.html#ready">ready</a></li><li data-type='method'><a href="ManualResetSignal.html#reset">reset</a></li><li data-type='method'><a href="ManualResetSignal.html#set">set</a></li></ul></li><li><a href="Message.html">Message</a></li><li><a href="MetaData.html">MetaData</a></li><li><a href="ModelList.html">ModelList</a><ul class='methods'><li data-type='method'><a href="ModelList.html#add">add</a></li><li data-type='method'><a href="ModelList.html#clear">clear</a></li><li data-type='method'><a href="ModelList.html#fire">fire</a></li><li data-type='method'><a href="ModelList.html#items">items</a></li><li data-type='method'><a href="ModelList.html#on">on</a></li><li data-type='method'><a href="ModelList.html#one">one</a></li><li data-type='method'><a href="ModelList.html#remove">remove</a></li><li data-type='method'><a href="ModelList.html#resume">resume</a></li><li data-type='method'><a href="ModelList.html#stop">stop</a></li></ul></li><li><a href="NestedStartResult.html">NestedStartResult</a></li><li><a href="NestedTimingTracker.html">NestedTimingTracker</a><ul class='methods'><li data-type='method'><a href="NestedTimingTracker.html#child">child</a></li><li data-type='method'><a href="NestedTimingTracker.html#context">context</a></li><li data-type='method'><a href="NestedTimingTracker.html#error">error</a></li><li data-type='method'><a href="NestedTimingTracker.html#event">event</a></li><li data-type='method'><a href="NestedTimingTracker.html#start">start</a></li><li data-type='method'><a href="NestedTimingTracker.html#uuid">uuid</a></li></ul></li><li><a href="OrderedModelList.html">OrderedModelList</a><ul class='methods'><li data-type='method'><a href="OrderedModelList.html#add">add</a></li><li data-type='method'><a href="OrderedModelList.html#clear">clear</a></li><li data-type='method'><a href="OrderedModelList.html#fire">fire</a></li><li data-type='method'><a href="OrderedModelList.html#items">items</a></li><li data-type='method'><a href="OrderedModelList.html#on">on</a></li><li data-type='method'><a href="OrderedModelList.html#one">one</a></li><li data-type='method'><a href="OrderedModelList.html#orderBy">orderBy</a></li><li data-type='method'><a href="OrderedModelList.html#remove">remove</a></li><li data-type='method'><a href="OrderedModelList.html#resume">resume</a></li><li data-type='method'><a href="OrderedModelList.html#stop">stop</a></li></ul></li><li><a href="PagedModelList.html">PagedModelList</a><ul class='methods'><li data-type='method'><a href="PagedModelList.html#add">add</a></li><li data-type='method'><a href="PagedModelList.html#clear">clear</a></li><li data-type='method'><a href="PagedModelList.html#fire">fire</a></li><li data-type='method'><a href="PagedModelList.html#items">items</a></li><li data-type='method'><a href="PagedModelList.html#nextPage">nextPage</a></li><li data-type='method'><a href="PagedModelList.html#on">on</a></li><li data-type='method'><a href="PagedModelList.html#one">one</a></li><li data-type='method'><a href="PagedModelList.html#pageIndex">pageIndex</a></li><li data-type='method'><a href="PagedModelList.html#pageSize">pageSize</a></li><li data-type='method'><a href="PagedModelList.html#prevPage">prevPage</a></li><li data-type='method'><a href="PagedModelList.html#remove">remove</a></li><li data-type='method'><a href="PagedModelList.html#resume">resume</a></li><li data-type='method'><a href="PagedModelList.html#stop">stop</a></li></ul></li><li><a href="ProcessContext.html">ProcessContext</a><ul class='methods'><li data-type='method'><a href="ProcessContext.html#cancel">cancel</a></li><li data-type='method'><a href="ProcessContext.html#stop">stop</a></li><li data-type='method'><a href="ProcessContext.html#update">update</a></li></ul></li><li><a href="ProcessLogic.html">ProcessLogic</a><ul class='methods'><li data-type='method'><a href="ProcessLogic.html#contextFromArgs">contextFromArgs</a></li><li data-type='method'><a href="ProcessLogic.html#getInitialActions">getInitialActions</a></li><li data-type='method'><a href="ProcessLogic.html#getNextActions">getNextActions</a></li></ul></li><li><a href="ProcessTransition.html">ProcessTransition</a></li><li><a href="ProcessTransitions.html">ProcessTransitions</a></li><li><a href="Proxy.html">Proxy</a><ul class='methods'><li data-type='method'><a href="Proxy.html#apply">apply</a></li><li data-type='method'><a href="Proxy.html#url">url</a></li><li data-type='method'><a href="Proxy.html#use">use</a></li></ul></li><li><a href="ProxyRule.html">ProxyRule</a></li><li><a href="Request.html">Request</a></li><li><a href="Response.html">Response</a></li><li><a href="SelectionModelList.html">SelectionModelList</a><ul class='methods'><li data-type='method'><a href="SelectionModelList.html#add">add</a></li><li data-type='method'><a href="SelectionModelList.html#clear">clear</a></li><li data-type='method'><a href="SelectionModelList.html#fire">fire</a></li><li data-type='method'><a href="SelectionModelList.html#items">items</a></li><li data-type='method'><a href="SelectionModelList.html#on">on</a></li><li data-type='method'><a href="SelectionModelList.html#one">one</a></li><li data-type='method'><a href="SelectionModelList.html#remove">remove</a></li><li data-type='method'><a href="SelectionModelList.html#resume">resume</a></li><li data-type='method'><a href="SelectionModelList.html#selected">selected</a></li><li data-type='method'><a href="SelectionModelList.html#stop">stop</a></li><li data-type='method'><a href="SelectionModelList.html#toggle">toggle</a></li></ul></li><li><a href="Semaphore.html">Semaphore</a><ul class='methods'><li data-type='method'><a href="Semaphore.html#ready">ready</a></li><li data-type='method'><a href="Semaphore.html#release">release</a></li></ul></li><li><a href="Spy.html">Spy</a><ul class='methods'><li data-type='method'><a href="Spy.html#invokes">invokes</a></li><li data-type='method'><a href="Spy.html#onCall">onCall</a></li><li data-type='method'><a href="Spy.html#returns">returns</a></li><li data-type='method'><a href="Spy.html#throws">throws</a></li></ul></li><li><a href="SpyBehaviors.html">SpyBehaviors</a><ul class='methods'><li data-type='method'><a href="SpyBehaviors.html#invokes">invokes</a></li><li data-type='method'><a href="SpyBehaviors.html#returns">returns</a></li><li data-type='method'><a href="SpyBehaviors.html#throws">throws</a></li></ul></li><li><a href="SpyCall.html">SpyCall</a></li><li><a href="Store.html">Store</a><ul class='methods'><li data-type='method'><a href="Store.html#delete">delete</a></li><li data-type='method'><a href="Store.html#get">get</a></li><li data-type='method'><a href="Store.html#set">set</a></li></ul></li><li><a href="Tracker.html">Tracker</a><ul class='methods'><li data-type='method'><a href="Tracker.html#child">child</a></li><li data-type='method'><a href="Tracker.html#context">context</a></li><li data-type='method'><a href="Tracker.html#error">error</a></li><li data-type='method'><a href="Tracker.html#event">event</a></li><li data-type='method'><a href="Tracker.html#start">start</a></li><li data-type='method'><a href="Tracker.html#uuid">uuid</a></li></ul></li><li><a href="TrackingInfo.html">TrackingInfo</a></li><li><a href="Transformer.html">Transformer</a><ul class='methods'><li data-type='method'><a href="Transformer.html#request">request</a></li><li data-type='method'><a href="Transformer.html#response">response</a></li></ul></li><li><a href="UniqueModelList.html">UniqueModelList</a><ul class='methods'><li data-type='method'><a href="UniqueModelList.html#add">add</a></li><li data-type='method'><a href="UniqueModelList.html#clear">clear</a></li><li data-type='method'><a href="UniqueModelList.html#fire">fire</a></li><li data-type='method'><a href="UniqueModelList.html#items">items</a></li><li data-type='method'><a href="UniqueModelList.html#on">on</a></li><li data-type='method'><a href="UniqueModelList.html#one">one</a></li><li data-type='method'><a href="UniqueModelList.html#remove">remove</a></li><li data-type='method'><a href="UniqueModelList.html#resume">resume</a></li><li data-type='method'><a href="UniqueModelList.html#stop">stop</a></li><li data-type='method'><a href="UniqueModelList.html#uniqueBy">uniqueBy</a></li></ul></li><li><a href="UpdatingModelList.html">UpdatingModelList</a><ul class='methods'><li data-type='method'><a href="UpdatingModelList.html#add">add</a></li><li data-type='method'><a href="UpdatingModelList.html#clear">clear</a></li><li data-type='method'><a href="UpdatingModelList.html#fire">fire</a></li><li data-type='method'><a href="UpdatingModelList.html#items">items</a></li><li data-type='method'><a href="UpdatingModelList.html#merge">merge</a></li><li data-type='method'><a href="UpdatingModelList.html#on">on</a></li><li data-type='method'><a href="UpdatingModelList.html#one">one</a></li><li data-type='method'><a href="UpdatingModelList.html#remove">remove</a></li><li data-type='method'><a href="UpdatingModelList.html#resume">resume</a></li><li data-type='method'><a href="UpdatingModelList.html#stop">stop</a></li><li data-type='method'><a href="UpdatingModelList.html#uniqueBy">uniqueBy</a></li><li data-type='method'><a href="UpdatingModelList.html#upsert">upsert</a></li></ul></li><li><a href="XSRFOptions.html">XSRFOptions</a></li></ul><h3>Modules</h3><ul><li><a href="module-data.html">data</a><ul class='methods'><li data-type='method'><a href="module-data.html#.createDataLayer">createDataLayer</a></li><li data-type='method'><a href="module-data.html#.createProxy">createProxy</a></li></ul></li><li><a href="module-data_utils.html">data/utils</a><ul class='methods'><li data-type='method'><a href="module-data_utils.html#.falloff">falloff</a></li><li data-type='method'><a href="module-data_utils.html#.tokenize">tokenize</a></li><li data-type='method'><a href="module-data_utils.html#.withAuthentication">withAuthentication</a></li><li data-type='method'><a href="module-data_utils.html#.withCache">withCache</a></li><li data-type='method'><a href="module-data_utils.html#.withConnectivity">withConnectivity</a></li><li data-type='method'><a href="module-data_utils.html#.withDiagnostics">withDiagnostics</a></li><li data-type='method'><a href="module-data_utils.html#.withHeaders">withHeaders</a></li><li data-type='method'><a href="module-data_utils.html#.withRetry">withRetry</a></li><li data-type='method'><a href="module-data_utils.html#.withSignal">withSignal</a></li><li data-type='method'><a href="module-data_utils.html#.withTransform">withTransform</a></li><li data-type='method'><a href="module-data_utils.html#.withXSRF">withXSRF</a></li></ul></li><li><a href="module-errors.html">errors</a><ul class='methods'><li data-type='method'><a href="module-errors.html#.error">error</a></li><li data-type='method'><a href="module-errors.html#.fatal">fatal</a></li><li data-type='method'><a href="module-errors.html#.ignore">ignore</a></li><li data-type='method'><a href="module-errors.html#.rethrow">rethrow</a></li></ul></li><li><a href="module-index.html">index</a><ul class='methods'><li data-type='method'><a href="module-index.html#~buffer">buffer</a></li><li data-type='method'><a href="module-index.html#~eventBus">eventBus</a></li><li data-type='method'><a href="module-index.html#~invokeIf">invokeIf</a></li><li data-type='method'><a href="module-index.html#~parallel">parallel</a></li><li data-type='method'><a href="module-index.html#~sequence">sequence</a></li></ul></li><li><a href="module-models.html">models</a><ul class='methods'><li data-type='method'><a href="module-models.html#.modelList">modelList</a></li><li data-type='method'><a href="module-models.html#.withActive">withActive</a></li><li data-type='method'><a href="module-models.html#.withFiltering">withFiltering</a></li><li data-type='method'><a href="module-models.html#.withGrouping">withGrouping</a></li><li data-type='method'><a href="module-models.html#.withOrdering">withOrdering</a></li><li data-type='method'><a href="module-models.html#.withPaging">withPaging</a></li><li data-type='method'><a href="module-models.html#.withSelection">withSelection</a></li><li data-type='method'><a href="module-models.html#.withUnique">withUnique</a></li><li data-type='method'><a href="module-models.html#.withUpdating">withUpdating</a></li></ul></li><li><a href="module-process.html">process</a><ul class='methods'><li data-type='method'><a href="module-process.html#.action">action</a></li><li data-type='method'><a href="module-process.html#.dependencies">dependencies</a></li><li data-type='method'><a href="module-process.html#.process">process</a></li><li data-type='method'><a href="module-process.html#.run">run</a></li><li data-type='method'><a href="module-process.html#.transitions">transitions</a></li></ul></li><li><a href="module-signals.html">signals</a><ul class='methods'><li data-type='method'><a href="module-signals.html#.autoReset">autoReset</a></li><li data-type='method'><a href="module-signals.html#.countdown">countdown</a></li><li data-type='method'><a href="module-signals.html#.manualReset">manualReset</a></li><li data-type='method'><a href="module-signals.html#.semaphore">semaphore</a></li></ul></li><li><a href="module-stores.html">stores</a><ul class='methods'><li data-type='method'><a href="module-stores.html#.memoryStore">memoryStore</a></li></ul></li><li><a href="module-stores_utils.html">stores/utils</a><ul class='methods'><li data-type='method'><a href="module-stores_utils.html#.asDataCache">asDataCache</a></li><li data-type='method'><a href="module-stores_utils.html#.days">days</a></li><li data-type='method'><a href="module-stores_utils.html#.hours">hours</a></li><li data-type='method'><a href="module-stores_utils.html#.minutes">minutes</a></li><li data-type='method'><a href="module-stores_utils.html#.weeks">weeks</a></li><li data-type='method'><a href="module-stores_utils.html#.withEncryption">withEncryption</a></li><li data-type='method'><a href="module-stores_utils.html#.withExpiration">withExpiration</a></li><li data-type='method'><a href="module-stores_utils.html#.withPrefix">withPrefix</a></li></ul></li><li><a href="module-test.html">test</a><ul class='methods'><li data-type='method'><a href="module-test.html#.spy">spy</a></li></ul></li><li><a href="module-tracker.html">tracker</a><ul class='methods'><li data-type='method'><a href="module-tracker.html#.createTracker">createTracker</a></li><li data-type='method'><a href="module-tracker.html#.withNesting">withNesting</a></li></ul></li><li><a href="module-tracker_utils.html">tracker/utils</a><ul class='methods'><li data-type='method'><a href="module-tracker_utils.html#~withReplacement">withReplacement</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Promise.html">Promise</a></li></ul><h3>Events</h3><ul><li><a href="ActiveModelList.html#~event:active-change">active-change</a></li><li><a href="FilteredModelList.html#~event:filter-change">filter-change</a></li><li><a href="GroupedModelList.html#~event:group-change">group-change</a></li><li><a href="ModelList.html#~event:items-add">items-add</a></li><li><a href="ModelList.html#~event:items-remove">items-remove</a></li><li><a href="OrderedModelList.html#~event:order-change">order-change</a></li><li><a href="PagedModelList.html#~event:page-change">page-change</a></li><li><a href="SelectionModelList.html#~event:selection-change">selection-change</a></li><li><a href="UniqueModelList.html#~event:unique-change">unique-change</a></li><li><a href="UpdatingModelList.html#~event:items-update">items-update</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Adapter">Adapter</a></li><li><a href="global.html#Fetch">Fetch</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">stores/utils.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import sjcl from 'sjcl';
import memoize from 'lodash/memoize.js';
import identity from 'lodash/identity.js';
import isEmpty from 'lodash/isEmpty.js';
import isFunction from 'lodash/isFunction.js';
import conforms from 'lodash/conforms.js';
import stubTrue from 'lodash/stubTrue.js';
import cond from 'lodash/cond.js';

import {
    Cache,
    Store,
    EncryptionConfiguration,
} from '../types/stores.js';

class Unused extends Cache {}
class UnusedStore extends Store {}
class Configuration extends EncryptionConfiguration {}

/**
 * Contains utility methods for working with Stores.
 *
 * @module stores/utils
 */

/**
 * Wraps a {@link Store} instance so values are encrypted and
 * decrypted transparently when get and set. For increased security,
 * the key used to store a value will also be used to salt the given
 * private key, ensuring each object is stored with a unique key.
 *
 * @param {Store} store Underlying Store instance whose values will
 * be encrypted during `set` calls and decrypted during `get` calls.
 * @param {EncryptionConfiguration} config Indicates which encryption
 * method and encryption key to use.
 * @returns {Store} A Store instance that will encrypt and decrypt
 * values in the underlying store transparently.
 * @example
 * // random private key and initialization vector
 *
 * import { memoryStore } from '@paychex/core/stores';
 * import { withEncryption } from '@paychex/core/stores/utils';
 *
 * const iv = window.crypto.getRandomBytes(new UintArray(16));
 * const key = window.crypto.getRandomBytes(new UintArray(8));
 *
 * export const lockbox = withEncryption(memoryStore(), { key, iv });
 * @example
 * // user-specific private key and initialization vector
 *
 * import { proxy } from 'path/to/proxy';
 * import { indexedDB } from '@paychex/core/stores'
 * import { withEncryption } from '@paychex/core/stores/utils';
 * import { getUserPrivateKey, getUserGUID } from '../data/user';
 *
 * const database = indexedDB({ store: 'my-store' });
 *
 * export async function loadData(id) {
 *   const iv = await getUserGUID();
 *   const key = await getUserPrivateKey();
 *   const encrypted = withEncryption(database, { key, iv });
 *   try {
 *     return await encrypted.get(id);
 *   } catch (e) {
 *     return await someDataCall(...)
 *       .then(value => {
 *          encrypted.set(id, value);
 *          return value;
 *       });
 *   }
 * }
 */
export function withEncryption(store, { key, iv }) {

    const vector = sjcl.codec.utf8String.toBits(iv);
    const secret = memoize(function generateKey(salt) {
        return sjcl.misc.pbkdf2(key, salt);
    });

    async function encrypt(value, salt) {
        const json = JSON.stringify(value);
        const bits = sjcl.codec.utf8String.toBits(json);
        const aes = new sjcl.cipher.aes(secret(salt));
        const bytes = sjcl.mode.ccm.encrypt(aes, bits, vector);
        return sjcl.codec.hex.fromBits(bytes);
    }

    async function decrypt(value, salt) {
        const bytes = sjcl.codec.hex.toBits(value);
        const aes = new sjcl.cipher.aes(secret(salt));
        const bits = sjcl.mode.ccm.decrypt(aes, bytes, vector);
        const json = sjcl.codec.utf8String.fromBits(bits);
        return JSON.parse(json);
    }

    return {

        async get(item) {
            const cleartext = data => decrypt(data, item);
            return await store.get(item).then(cleartext);
        },

        async set(item, value) {
            const setInStore = data => store.set(item, data);
            return await encrypt(value, item).then(setInStore);
        },

        async delete(item) {
            return await store.delete(item);
        }

    };

}

const getPrefixer = cond([
    [isFunction, identity],
    [isEmpty, () => identity],
    [stubTrue, (prefix) => (key) => `${prefix}:${key}`],
]);

/**
 * Method used to modify a key for use in a Store. Used primarily by
 * {@link module:stores/utils.withPrefix withPrefix}.
 *
 * @global
 * @callback Prefixer
 * @param {string} key The key to modify before passing to a Store.
 * @returns {string} The modified key to use in a Store.
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withPrefix } from '@paychex/core/stores/utils';
 * import { user } from '../data/user';
 *
 * const store = withPrefix(localStore(), function(key) {
 *   return `${key}|${user.guid}`;
 * });
 */

/**
 * Wraps a Store so any keys are transparently modified before access.
 * This can be useful when storing data on a machine that will have
 * more than 1 user, to ensure different users don't access each other's
 * stored information.
 *
 * @param {Store} store The store whose keys should be modified before access.
 * @param {string|Prefixer} prefix A string to prepend to any keys _or_ a
 * function that will modify a key.
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withPrefix } from '@paychex/core/stores/utils';
 * import { user } from '../data/user';
 *
 * const store = withPrefix(localStore(), user.guid);
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withPrefix } from '@paychex/core/stores/utils';
 * import { user } from '../data/user';
 *
 * const store = withPrefix(localStore(), function(key) {
 *   return `${key}|${user.guid}`;
 * });
 */
export function withPrefix(store, prefix) {

    const prefixer = getPrefixer(prefix);

    return {

        async get(key) {
            return await store.get(prefixer(key));
        },

        async set(key, value) {
            return await store.set(prefixer(key), value);
        },

        async delete(key) {
            return await store.delete(prefixer(key));
        }

    };

}

/**
 * Factory method that returns a new Date instance on each invocation.
 *
 * @global
 * @callback DateFactory
 * @returns {Date} A Date object.
 * @see {@link module:stores/utils.withExpiration withExpiration}
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withExpiration } from '@paychex/core/stores/utils';
 *
 * export const store = withExpiration(localStore(), function sevenDays() {
 *   const now = Date.now();
 *   const days = 24 * 60 * 60 * 1000;
 *   return new Date(now + 7 * days);
 * });
 */

/**
 * Creates a {@link DateFactory} that returns a Date the specified number of
 * weeks in the future.
 *
 * @function
 * @param {number} count The number of weeks in the future the Date should be.
 * @returns {DateFactory} A function that returns a Date.
 * @see {@link module:stores/utils.withExpiration withExpiration}
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withExpiration, weeks } from '@paychex/core/stores/utils';
 *
 * export const store = withExpiration(localStore(), weeks(2));
 */
export function weeks(count) {
    return days(count * 7);
}

/**
 * Creates a {@link DateFactory} that returns a Date the specified number of
 * days in the future.
 *
 * @function
 * @param {number} count The number of days in the future the Date should be.
 * @returns {DateFactory} A function that returns a Date.
 * @see {@link module:stores/utils.withExpiration withExpiration}
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withExpiration, days } from '@paychex/core/stores/utils';
 *
 * export const store = withExpiration(localStore(), days(1));
 */
export function days(count) {
    return hours(count * 24);
}

/**
 * Creates a {@link DateFactory} that returns a Date the specified number of
 * hours in the future.
 *
 * @function
 * @param {number} count The number of hours in the future the Date should be.
 * @returns {DateFactory} A function that returns a Date.
 * @see {@link module:stores/utils.withExpiration withExpiration}
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withExpiration, hours } from '@paychex/core/stores/utils';
 *
 * export const store = withExpiration(localStore(), hours(8));
 */
export function hours(count) {
    return minutes(count * 60);
}

/**
 * Creates a {@link DateFactory} that returns a Date the specified number of
 * minutes in the future.
 *
 * @function
 * @param {number} count The number of minutes in the future the Date should be.
 * @returns {DateFactory} A function that returns a Date.
 * @see {@link module:stores/utils.withExpiration withExpiration}
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withExpiration, minutes } from '@paychex/core/stores/utils';
 *
 * export const store = withExpiration(localStore(), minutes(90));
 */
export function minutes(count) {
    return function dateFactory() {
        const now = Date.now();
        const offset = count * 60 * 1000;
        return new Date(now + offset);
    };
}

function afterNow(date) {
    return date > new Date();
}

const isNotExpired = conforms({ expires: afterNow });

/**
 * Wraps a Store so values expire after a specified Date. Any attempts to
 * retrieve a value after it has expired will return `undefined`.
 *
 * @function
 * @param {Store} store The store to wrap.
 * @param {DateFactory} dateFactory Function to create expiration Dates.
 * @returns {Store} A Store that returns `undefined` if a value has expired.
 * @example
 * import { localStore } from '@paychex/core/stores';
 * import { withExpiration, minutes } from '@paychex/core/stores/utils';
 *
 * export const store = withExpiration(localStore(), minutes(90));
 * @example
 * import { indexedDB } from '@paychex/core/stores';
 * import { withCache } from '@paychex/core/data/utils';
 * import { asDataCache, withEncryption, withExpiration, days } from '@paychex/core/stores/utils';
 *
 * import { user } from '../path/to/user';
 * import { fetch, createRequest } from '../path/to/datalayer';
 *
 * const reports = indexedDB({ store: 'reports' });
 * const expires = withExpiration(reports, days(30));
 * const encrypted = withEncryption(expires, {
 *   iv: user.id,
 *   key: user.privateKey,
 * });
 *
 * const operation = {
 *   base: 'reports',
 *   path: '/reports/:id'
 * };
 *
 * const pipeline = withCache(fetch, asDataCache(encrypted));
 *
 * export async function getReportById(id) {
 *   const request = createRequest(operation, { id });
 *   const response = await pipeline(request);
 *   return response.data;
 * }
 */
export function withExpiration(store, dateFactory) {

    return {

        ...store,

        async get(key) {
            const entry = await store.get(key);
            if (isNotExpired(entry))
                return entry.value;
        },

        async set(key, value) {
            return await store.set(key, {
                value,
                expires: dateFactory()
            });
        }

    };

}

/**
 * Utility method to wrap a {@link Store} implementation as a {@link Cache}
 * instance. Uses the {@link Request} url as the cache key.
 *
 * @param {Store} store The Store implementation to use as the Cache backing.
 * @returns {Cache} A Cache implementation backed by the specified Store.
 * @example
 * import { rethrow } from '@paychex/core/errors';
 * import { withCache } from '@paychex/core/data/utils';
 * import { indexedDB } from '@paychex/core/stores';
 * import { asDataCache } from '@paychex/core/stores/utils';
 * import { createRequest, fetch } from '~/path/to/datalayer';
 *
 * const dataCall = {
 *   method: 'GET',
 *   base: 'server',
 *   path: '/values/:key'
 * };
 *
 * // NOTE: use withEncryption(store, options) if the response
 * // might contain personal or sensitive information that you
 * // wish to keep secret
 * const store = indexedDB({ store: 'myDataValues' });
 * const attempt = withCache(fetch, asDataCache(store));
 *
 * export async function loadData(key) {
 *   const params = { key };
 *   const request = createRequest(dataCall, params);
 *   const response = await attempt(request).catch(rethrow(params));
 *   return response.data;
 * }
 */
export function asDataCache(store) {

    return {

        async get(request) {
            return await store.get(request.url);
        },

        async set(request, response) {
            return await store.set(request.url, response);
        }

    };

}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
